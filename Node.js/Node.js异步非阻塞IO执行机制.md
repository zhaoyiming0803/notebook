### Node.js 基本介绍

[关于 Node.js](https://nodejs.org/zh-cn/about/)

阻塞IO和非阻塞IO的区别就在于：系统接收输入再到输出期间，能不能再接收其他输入

### 阻塞与非阻塞

[Node.js 官网对阻塞与非阻塞的介绍](https://nodejs.org/zh-cn/docs/guides/blocking-vs-non-blocking/)

### Node 事件循环的流程

1、在进程启动时，Node 会创建一个类似于 while (true) 的循环，每执行一次循环体的过程就是一次 tick。

2、每个 tick 的过程就是查看是否有事件待处理，如果有就取出事件及相关的回调函数，然后进入下一个循环，如果不再有事件处理，就退出进程。

### 每个 tick 的过程中，如何判断是否有事件需要处理？

1、每个事件循环中有一个或多个观察者，而判断是否有事件需要处理的过程就是向这些观察者询问是否有要处理的事件。

2、在 Node 中，事件主要来源于网络请求、文件的 I/O 等。这些事件对应的观察者有文件 I/O 观察者，网络 I/O 观察者。

3、事件循环是一个典型的生产者/消费者模型。异步 I/O、网络请求等则是事件的生产者，源源不断为 Node 提供不同类型的事件，这些事件被传递到对应的观察者那里，事件循环则从观察者那里取出事件并处理。

4、在 windows 下，这个循环基于 IOCP 创建，在 *nix 下基于多线程创建。

### 异步 I/O 结合事件循环

因为是单线程的，所以当顺序执行js文件中的代码的时候，事件循环是被暂停的。

当主线程上的js代码执行完以后，事件循环开始运行，并从消息队列中取出消息，开始执行回调函数

因为是单线程的，所以当回调函数被执行的时候，事件循环是被暂停的

当涉及到I/O操作的时候，nodejs会开一个独立的线程来进行异步I/O操作，操作结束以后将消息压入消息队列。

参考代码：

``` javascript
var fs = require('fs');
var debug = require('debug')('example1');
 
debug("begin");
 
fs.readFile('package.json', 'utf-8', function (err, data) {
  if(err)  
    debug(err);
  else
    debug('get file content');
});
 
setTimeout(function(){
  debug('timeout2');
}, 1000);
 
debug('end');
```

上述代码执行顺序如下：

同步执行debug("begin")

异步调用fs.readFile()，此时会开一个新的线程去进行异步I/O操作

异步调用setTimeout()，1s后将超时信息压入到消息队列中

同步调用debug("end")

开启事件循环，弹出消息队列中的信息(目前是超时信息)

然后执行信息对应的回调函数，此时事件循环又被暂停，参考 Node.js 官网说明：阻塞 是指在 Node.js 程序中，其它 JavaScript 语句的执行，必须等待一个非 JavaScript 操作完成。这是因为当 阻塞 发生时，事件循环无法继续运行JavaScript。

回调函数执行结束后，开始事件循环(目前消息队列中没有任何东西，文件还没读完)

异步I/O读取文件完毕，将消息压入消息队列(消息中含有文件内容或者是出错信息)

事件循环取得消息，执行回调

程序退出。

### IO 模式

I/O 是一个很宽泛的词，每个设备都会有一个专用的 I/O 地址，用来处理自己的输入输出信息。一次 API 接口调用、向磁盘写入日志信息，其实就是在跟 I/O 打交道。一次 I/O 操作分为【等待资源】、【使用资源】两个阶段。

好文参考《[迄今为止把同步/异步/阻塞/非阻塞/BIO/NIO/AIO讲的最清楚的好文章](https://juejin.im/post/5cff70c0f265da1ba56b14fd)》

IO指的就是读入/写出数据的过程，和等待读入/写出数据的过程。一旦拿到数据后就变成了数据操作了，就不是IO了。 拿网络IO来说，等待的过程就是数据从网络到网卡再到内核空间。读写的过程就是内核空间和用户空间的相互拷贝。
所以IO就包括两个过程，一个是等待数据的过程，一个是读写（拷贝）数据的过程。而且还要明白，一定不能包括操作数据的过程。

![image](https://user-gold-cdn.xitu.io/2019/6/11/16b45d0adffda333?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

对于一次IO访问（以read举例），数据会先被拷贝到操作系统内核的缓冲区中，然后才会从操作系统内核的缓冲区拷贝到应用程序的地址空间。所以说，当一个read操作发生时，它会经历两个阶段：

- 等待数据准备 (Waiting for the data to be ready)
- 将数据从内核拷贝到进程中 (Copying the data from the kernel to the process)

正式因为这两个阶段，linux系统产生了下面五种网络模式的方案。
- 阻塞 I/O（blocking IO）
- 非阻塞 I/O（nonblocking IO）
- I/O 多路复用（ IO multiplexing）
- 信号驱动 I/O（ signal driven IO）
- 异步 I/O（asynchronous IO）

### 同步 IO 和同步阻塞 IO

同步 IO 是指发起 IO 请求后，必须拿到 IO 的数据才可以继续执行。 按照程序的表现形式又分为两种： 在等待数据的过程中，和拷贝数据的过程中，线程都在阻塞，这就是同步阻塞 IO。

在等待数据的过程中，线程采用死循环式轮询，在拷贝数据的过程中，线程在阻塞，这其实还是同步阻塞 IO。

网上很多文章把第二种归为同步非阻塞 IO，这肯定是错误的，它一定是阻塞 IO，因为拷贝数据的过程，线程是阻塞的。 严格来讲，在 IO 的概念上，同步和非阻塞是不可能搭配的，因为它们是一对相悖的概念。 同步 IO 意味着必须拿到 IO 的数据，才可以继续执行。因为后续操作依赖 IO 数据，所以它必须是阻塞的。

非阻塞 IO 意味着发起 IO 请求后，可以继续往下执行。说明后续执行不依赖于 IO 数据，所以它肯定不是同步的。 因此，在 IO 上，同步和非阻塞是互斥的，所以不存在同步非阻塞 IO。但同步非阻塞是存在的，那不叫 IO，叫操作数据了。

所以，同步 IO 一定是阻塞 IO，同步 IO 也就是同步阻塞 IO。既参与数据准备又参与数据读写。

![image](https://user-gold-cdn.xitu.io/2019/6/11/16b45d0adfd62772?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

### 异步 IO 和异步阻塞/非阻塞 IO

按照上文中对异步的理解，异步 IO 是指发起 IO 请求后，用户线程不用拿到 IO 的数据就可以继续执行。

用户线程的继续执行，和操作系统准备 IO 数据的过程是同时进行的，因此才叫做异步 IO。 按照 IO 数据的两个过程，又可以分为两种： 在等待数据的过程中，用户线程继续执行，在拷贝数据的过程中，线程在阻塞，这就是异步阻塞IO。

在等待数据的过程中，和拷贝数据的过程中，用户线程都在继续执行，这就是异步非阻塞 IO。

第一种情况是，用户线程没有参与数据等待的过程，所以它是异步的。但用户线程参与了数据拷贝的过程，所以它又是阻塞的。合起来就是异步阻塞 IO。

第二种情况是，用户线程既没有参与等待过程也没有参与拷贝过程，所以它是异步的。当它接到通知时，数据已经准备好了，它没有因为 IO 数据而阻塞过，所以它又是非阻塞的。合起来就是异步非阻塞 IO。

### 白话风格讲解 I/O 模型的演进

故事标题：小明与妹子的邂逅

故事情节：小明在校园一次文艺晚会上邂逅了一位妹子，在只得知妹子名字、手机号的情况下，经过几天的苦苦追寻，历经千山万水，终得美人归！

演员介绍：男一号@小明、女一号@妹子、串场@门卫大爷

1、同步阻塞 I/O 模式

小明电话相约妹子在校门口，然后小明很专一、不见到妹子不回家，期间没有做任何事情，一直在等待！

2、同步非阻塞模式（并不存在同步非阻塞IO）

小明电话相约妹子在校门口，妹子还没准备好（出门前化妆几小时。。。），这时候的小明很执着，每隔一会儿给妹子发个信息直到妹子准备好了。

3、I/O 多路复用模式

select 小明电话相约妹子在校门口，委托门卫 select 大爷帮忙，select 大爷很敬业每出去一个人都会进行询问，但是select 大爷有个限制最多只能询问 1024 个。

poll 类似于select功能，不同的是 poll 大爷没有1024限制，可以一直坚持，但是当poll大爷超过 1024，询问的越来越多之后就显得越来越精疲力尽了。

epoll 小明电话相约妹子在校门口，委托门卫 epoll 大爷帮忙，epoll 大爷不再是每个询问，规定每个人出入校门必须带上学生证，这样 epoll 大爷就是知道哪个是小明的女神了，epoll 大爷找到女神之后再电话通知小明。

参考：https://segmentfault.com/a/1190000016400053

4、信号驱动 I/O 模式

小明电话相约妹子在校门口，此时妹子回复说我还没准备好（出门前化妆几小时。。。），这个时候小明也没去，而是先去干其它事情了，等妹子准备好之后电话通知小明，我已经准备好了，小明这个时候才去校门口等着和妹子的约会。

5、异步 I/O 模式

小明告诉妹子我们在校园门口相约，之后小明没有在那干等了，而是先回宿舍休息会或者和朋友在打会球等等，妹子到校门口之后电话通知小明，我已经来啦。

参考：

https://mp.weixin.qq.com/s/j44U62unfQHlRJcJwq29ng
