### Node 事件循环的流程

1、在进程启动时，Node 会创建一个类似于 while (true) 的循环，没执行一次循环体的过程就是一次 tick。

2、每个 tick 的过程就是查看是否有事件待处理，如果有就取出事件及相关的回调函数，然后进入下一个循环，如果不再有事件处理，就退出进程。

### 每个 tick 的过程中，如何判断是否有事件需要处理？

1、每个事件循环中有一个或多个观察者，而判断是否有事件需要处理的过程就是向这些观察者询问是否有要处理的事件。

2、在 Node 中，事件主要来源于网络请求、文件的 I/O 等。这些事件对应的观察者有文件 I/O观察者，网络 I/O观察者。

3、事件循环是一个典型的生产者/消费者模型。异步 I/O、网络请求等则是事件的生产者，源源不断为 Node 提供不同类型的事件，这些事件被传递到对应的观察者那里，事件循环则从观察者那里取出事件并处理。

4、在 windows 下，这个循环基于 IOCP 创建，在 *nix 下基于多线程创建。

### 整个异步 IO 的流程

简单来说，阻塞 I/O 就是当用户发一个读取文件描述符的操作的时候，进程就会被阻塞，直到要读取的数据全部准备好返回给用户，这时候进程才会结束 block 的状态。

而非阻塞 I/O 则是用户发起一个读取文件的描述符操作的时候，函数立即返回，不做任何等待，进程继续执行，但是程序如何知道要读取的数据已经准备好了呢？最简单的方法就是轮询。

除此之外，还有一种叫做 I/O 多路复用的模式，就是用一个阻塞函数同时监听多个文件描述符，当其中有一个文件描述符准备好了，就马上返回，在 linux 下，select、poll、epoll 都提供了 IO 多路复用的功能。

非阻塞 I/O 都不阻塞了为什么不是异步 I/O 呢？其实当非阻塞 I/O 准备好数据之后还是要阻塞进程去内核拿数据的，所以算不上异步 I/O。

### 异步 I/O 结合事件循环

因为是单线程的，所以当顺序执行js文件中的代码的时候，事件循环是被暂停的。

当主线程上的js代码执行完以后，事件循环开始运行，并从消息队列中取出消息，开始执行回调函数

因为是单线程的，所以当回调函数被执行的时候，事件循环是被暂停的

当涉及到I/O操作的时候，nodejs会开一个独立的线程来进行异步I/O操作，操作结束以后将消息压入消息队列。

参考代码：

``` javascript
var fs = require('fs');
var debug = require('debug')('example1');
 
debug("begin");
 
fs.readFile('package.json', 'utf-8', function (err, data) {
  if(err)  
    debug(err);
  else
    debug('get file content');
});
 
setTimeout(function(){
  debug('timeout2');
});
 
debug('end');
```

上述代码执行顺序如下：

同步执行debug("begin")

异步调用fs.readFile()，此时会开一个新的线程去进行异步I/O操作

异步调用setTimeout()，马上将超时信息压入到消息队列中

同步调用debug("end")

开启事件循环，弹出消息队列中的信息(目前是超时信息)

然后执行信息对应的回调函数(事件循环又被暂停)

回调函数执行结束后，开始事件循环(目前消息队列中没有任何东西，文件还没读完)

异步I/O读取文件完毕，将消息压入消息队列(消息中含有文件内容或者是出错信息)

事件循环取得消息，执行回调

程序退出。

### （非）阻塞 IO 和 同（异）步 IO

I/O 是一个很宽泛的词，每个设备都会有一个专用的 I/O 地址，用来处理自己的输入输出信息。一次 API 接口调用、向磁盘写入日志信息，其实就是在跟 I/O 打交道。一次 I/O 操作分为【等待资源】、【使用资源】两个阶段。

1、阻塞与非阻塞 I/O

阻塞与非阻塞 I/O 是对于操作系统内核而言的，发生在【等待资源】阶段，根据发起 I/O 请求是否阻塞来判断。

阻塞 I/O：这种模式下一个用户进程在发起一个 I/O 操作之后，只有收到响应或者超时才可进行处理其它事情，否则 I/O 将会一直阻塞。以读取磁盘上的一段文件为例，系统内核在完成磁盘寻道、读取数据、复制数据到内存中之后，这个调用才算完成。阻塞的这段时间对 CPU 资源是浪费的。

非阻塞 I/O：这种模式下一个用户进程发起一个 I/O 操作之后，如果数据没有就绪，会立刻返回（标志数据资源不可用），此时 CPU 时间片可以用来做一些其它事情。

2、同步与异步 I/O

同步与异步 I/O 发生在【使用资源】阶段，根据实际 I/O 操作来判断。

同步 I/O：应用发送或接收数据后，如果不返回，继续等待（此处发生阻塞），直到数据成功或失败返回。

异步 I/O：应用发送或接收数据后立刻返回，数据写入 OS 缓存，由 OS 完成数据发送或接收，并返回成功或失败的信息给应用。Node.js 就是典型的异步编程例子。

### 操作系统 I/O 模型演进

操作系统的 I/O 模型分为：阻塞 I/O、非阻塞 I/O、I/O 复用、信号驱动 I/O、异步 I/O 五种，本节参考 Unix 网络编程一书。

### 同步阻塞 IO

从应用程序开始系统调用->数据就绪进行拷贝->拷贝结束，这之间应用程序都处于等待状态，不能做其它事情，直到将数据拷贝到用户空间或出错才返回，我们称之为阻塞 I/O 模式。

### 同步非阻塞 IO

相比于同步阻塞 I/O 模式，同步非阻塞 I/O 在每次调用之后，如果数据没有就绪就会立即返回，之后重复调用来检查 I/O 操作是否就绪，这对 CPU 资源是一个极其浪费的操作，直到数据就绪将数据从内核拷贝到用户空间，返回成功指示给到应用程序。

### IO 多路复用

链接（Socket）并发大的情况，上面两种就不适合了，前面一个处理不完，后面就只能干等，这里就用到了 I/O 多路复用技术，先进行 select 数据就绪后，在调用 recvfrom 进行真正的 I/O 读写操作。它的高级之处还在于能够一个线程同时处理多个 Socket。

这里的 I/O 通常指网络 I/O，多路指多个 Socket 链接，复用指操作系统进行运算调度的最小单位线程。整体意思也就是多个网络 I/O 复用一个或少量的线程来处理 Socket。关于 I/O 多路复用的多种实现，继续参考下文。

1、select

通过轮询检查在文件描述符上设置的标识位来进行判断，select 的轮询相当于在数据库中查找一条记录没有建立索引，对所有的 socket 进行全部遍历，这对 CPU 是浪费的。另外 select 还有一个限制，对于单个进程所能打开的文件描述符最大只能是 1024，那么基于 select 的轮询技术最多也只能很好的处理 1000 并发的吞吐量，可以查看 上一个10年，著名的C10K并发连接问题

2、poll

poll 和 select 在实现上没有本质的区别，相比较 select，poll 基于链表来实现，没有了最大链接 1024 的限制。但是当文件描述符多了之后，每次调用都会对链接进行线性遍历，性能还是十分低下的。

3、epoll

是 linux 下效率最高的 I/O 事件通知机制，没有最大链接限制，通过 callbak 回调通知机制，不在是每次调用都对链接进行线性遍历，这样就不会随着文件描述符的增加导致效率下降。

在 1GB 内存的机器上能监听大约 10 万个端口，远超过 select 的 1024 限制，具体可以在服务器上查看 cat/proc/sys/fs/file-max

4、kqueue

与 epoll 类似，仅存于 FreeBSD（一种类UNIX操作系统）。

### 信号驱动 IO

仅在 Unix 上支持，与 I/O 多路复用相比避免了 select 的阻塞轮询。应用程序进行系统调用后立即返回，处理其它事物，在数据就绪之后系统会发送一个 SIGIO 信号到应用程序，应用进程开始读取数据。

### 异步 IO 模型

异步 I/O 模型是目前最理想的一种形式，应用程序发起系统调用后无需等待直接返回当前调用状态，进行后续的其它任务，结果由内核完成 I/O 操作之后通过回调通知到我们的应用程序，中间没有阻塞过程。

在 Linux2.6 之后增加了异步 I/O 的实现方式 AIO，但是很少系统能够实现。

### 白话风格讲解 I/O 模型的演进

故事标题：小明与妹子的邂逅

故事情节：小明在校园一次文艺晚会上邂逅了一位妹子，在只得知妹子名字、手机号的情况下，经过几天的苦苦追寻，历经千山万水，终得美人归！

演员介绍：男一号@小明、女一号@妹子、串场@门卫大爷

1、同步阻塞 I/O 模式

小明电话相约妹子在校门口，然后小明很专一、不见到妹子不回家，期间没有做任何事情，一直在等待！

2、同步非阻塞 I/O 模式

小明电话相约妹子在校门口，妹子还没准备好（出门前化妆几小时。。。），这时候的小明很执着，每隔一会儿给妹子发个信息直到妹子准备好了。

3、I/O 多路复用模式

select 小明电话相约妹子在校门口，委托门卫select大爷帮忙，select大爷很敬业每出去一个人都会进行询问，但是select大爷有个限制最多只能询问1024个。

poll poll类似于select功能，不同的是poll大爷没有1024限制，可以一直坚持，但是当poll大爷超过1024，询问的越来越多之后就显得越来越精疲力尽了。

epoll 小明电话相约妹子在校门口，委托门卫epoll大爷帮忙，epoll大爷不在是每个询问，规定每个人出入校门必须带上学生证，这样opoll大爷就是知道哪个是小明的女神了，epoll大爷找到女神之后在电话通知小明。

4、信号驱动 I/O 模式

小明电话相约妹子在校门口，此时妹子回复说我还没准备好（出门前化妆几小时。。。），这个时候小明也没去，而是先去干其它事情了，等妹子准备好之后电话通知小明，我已经准备好了，小明这个时候才去校门口等着和妹子的约会。

5、异步 I/O 模式

小明告诉妹子我们在校园门口相约，之后小明没有在那干等了，而是先回宿舍休息会或者和朋友在打会球等等，妹子到校门口之后电话通知小明，我已经来啦。

参考：

https://mp.weixin.qq.com/s/j44U62unfQHlRJcJwq29ng